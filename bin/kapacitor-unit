#!/bin/bash

usage() {
    echo "Usage $0 [-d <tick_script_directory>] [-t <tests_definition>]"
    echo "-h: Shows usage" 
    echo "-d: Full path of directory where tick scripts are located."
    echo "-t: Full path of tests definition file."
    echo ""
    echo "Kapacitor-unit is an unit test framework for Kapacitor alerts"
    echo ""
}

while getopts "d:t:h" var; do
    case ${var} in
        d) 	TICK_DIRECTORY=$OPTARG ;;
        t) 	TEST_DEF_FILE=$OPTARG ;;
        \?)
          echo 'Invalid option.'
          usage
          exit 1
          ;;
        *)
          usage
          exit 1
          ;;
    esac
done
shift $((OPTIND-1))   

if [ -z ${TEST_DEF_FILE:-} ] || [ -z ${TICK_DIRECTORY:-} ] ; then
 usage
 exit 0
fi

# Checks if tick directory exists:
if [ ! -d "$TICK_DIRECTORY" ]; then
	echo "ERROR: Directory where tick scripts are located not found (provide full path)."
	exit 1
fi

# Check if tests definition file exists
if [ ! -f "$TEST_DEF_FILE" ]; then
	echo "ERROR: Tests definition not found (provide full path)."
	exit 1
fi

# Defines environment variables for volume definition in docker-compose NOT WOKRING!
export KAPACITOR_UNIT_TICK_DIRECTORY=$TICK_DIRECTORY
export KAPACITOR_UNIT_TESTS_DEF_DIRECTORY=$(dirname "${TEST_DEF_FILE}")
export KAPACITOR_TESTS_DEF=$(basename "${TEST_DEF_FILE}")

docker-compose -f `dirname $0`/../components/docker-compose.yml up -d

# Cleaning up
#unset KAPACITOR_UNIT_TICK_DIRECTORY
#unset KAPACITOR_TESTS_DEF_DIRECTORY
#unset KAPACITOR_TESTS_DEF
